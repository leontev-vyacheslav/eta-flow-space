[
    {
        "id": "2dca6eed12b296f5",
        "type": "tab",
        "label": "flows-dispatcher",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "a7c135e772de0725",
        "type": "tab",
        "label": "pump-monitors",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "c975308c190de253",
        "type": "tab",
        "label": "Flow 1",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "b74b1a6d538c13c2",
        "type": "group",
        "z": "2dca6eed12b296f5",
        "name": "persistent-storage",
        "style": {
            "label": true
        },
        "nodes": [
            "443b413283d10c89",
            "abf540bef0e1bad8"
        ],
        "x": 34,
        "y": 919,
        "w": 632,
        "h": 82
    },
    {
        "id": "cbcfb9f537c21426",
        "type": "group",
        "z": "2dca6eed12b296f5",
        "name": "web",
        "style": {
            "label": true
        },
        "nodes": [
            "41c82c569adc9a0c",
            "d4fc72a987396215"
        ],
        "x": 28,
        "y": 33,
        "w": 1084,
        "h": 834
    },
    {
        "id": "41c82c569adc9a0c",
        "type": "group",
        "z": "2dca6eed12b296f5",
        "g": "cbcfb9f537c21426",
        "name": "api",
        "style": {
            "fill": "none",
            "label": true
        },
        "nodes": [
            "323402e3df4b64bc",
            "5cb3165ea305cfd7",
            "8a71ccaa19f8d878",
            "74479dcb06e8145c",
            "be8e1b2521c879ee",
            "e207d1a66a7650b9",
            "f89e2f3dce998039",
            "197bb63a4e854458",
            "d246a8475b5673ea",
            "d995a6e870520226",
            "82bde83f79f43412",
            "87a20acffb88c509",
            "a2eba094e5646ec9",
            "887420d8a5fb0d1d",
            "fafd204ba26a1f01",
            "43c3767d3d434ea5",
            "5bc46af389db248b",
            "0eef86469c73bd2e",
            "28cb881e9abfb828",
            "6e554427850e7e1a",
            "42be60bdf4323128",
            "40214b7ade58103d",
            "8dfd0c2c64939220",
            "6b6d605b33ba622a",
            "8e7193e6b1cfc533",
            "cfd3bfec49dd036d",
            "6d432d77ac870b96",
            "599dd7db8ee5cbb5"
        ],
        "x": 54,
        "y": 239,
        "w": 1032,
        "h": 602
    },
    {
        "id": "d4fc72a987396215",
        "type": "group",
        "z": "2dca6eed12b296f5",
        "g": "cbcfb9f537c21426",
        "name": "auth",
        "style": {
            "label": true,
            "fill": "none"
        },
        "nodes": [
            "cc420d657eea3b6f",
            "7fedb0406dc884b3",
            "281282e423102908",
            "ae53f3a719dc646f",
            "93590fb695220b2f",
            "0c78d8dd9d12fd1e"
        ],
        "x": 54,
        "y": 59,
        "w": 852,
        "h": 142
    },
    {
        "id": "e8c1afd9a301aa03",
        "type": "modbus-client",
        "name": "",
        "clienttype": "tcp",
        "bufferCommands": true,
        "stateLogEnabled": true,
        "queueLogEnabled": false,
        "failureLogEnabled": true,
        "tcpHost": "192.168.0.300",
        "tcpPort": 502,
        "tcpType": "DEFAULT",
        "serialPort": "/dev/ttyUSB",
        "serialType": "RTU-BUFFERD",
        "serialBaudrate": 9600,
        "serialDatabits": 8,
        "serialStopbits": 1,
        "serialParity": "none",
        "serialConnectionDelay": 100,
        "serialAsciiResponseStartDelimiter": "0x3A",
        "unit_id": 1,
        "commandDelay": 1,
        "clientTimeout": 1000,
        "reconnectOnTimeout": false,
        "reconnectTimeout": 2000,
        "parallelUnitIdsAllowed": true,
        "showErrors": true,
        "showWarnings": true,
        "showLogs": true
    },
    {
        "id": "cc420d657eea3b6f",
        "type": "http in",
        "z": "2dca6eed12b296f5",
        "g": "d4fc72a987396215",
        "name": "",
        "url": "/sign-in",
        "method": "post",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 100,
        "wires": [
            [
                "7fedb0406dc884b3"
            ]
        ]
    },
    {
        "id": "7fedb0406dc884b3",
        "type": "function",
        "z": "2dca6eed12b296f5",
        "g": "d4fc72a987396215",
        "name": "sign-in",
        "func": "const { signIn } = global.get('routes');\n\nreturn await signIn(msg);",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 430,
        "y": 100,
        "wires": [
            [
                "281282e423102908"
            ]
        ]
    },
    {
        "id": "281282e423102908",
        "type": "http response",
        "z": "2dca6eed12b296f5",
        "g": "d4fc72a987396215",
        "name": "http-sign-in-response",
        "statusCode": "",
        "headers": {},
        "x": 780,
        "y": 100,
        "wires": []
    },
    {
        "id": "323402e3df4b64bc",
        "type": "http in",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "",
        "url": "/api/devices",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 340,
        "wires": [
            [
                "5cb3165ea305cfd7"
            ]
        ]
    },
    {
        "id": "5cb3165ea305cfd7",
        "type": "function",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "get-devices",
        "func": "const { getDevices } = global.get('routes');\n\nreturn await getDevices(msg);",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 340,
        "wires": [
            [
                "8a71ccaa19f8d878"
            ]
        ]
    },
    {
        "id": "8a71ccaa19f8d878",
        "type": "http response",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "http-get-devices-response",
        "statusCode": "",
        "headers": {},
        "x": 830,
        "y": 340,
        "wires": []
    },
    {
        "id": "74479dcb06e8145c",
        "type": "http in",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "",
        "url": "/api/states/device/:deviceId",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 210,
        "y": 400,
        "wires": [
            [
                "be8e1b2521c879ee"
            ]
        ]
    },
    {
        "id": "be8e1b2521c879ee",
        "type": "function",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "get-device-state",
        "func": "const { getDeviceState } = global.get('routes');\n\nreturn await getDeviceState(msg, global);",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 400,
        "wires": [
            [
                "e207d1a66a7650b9"
            ]
        ]
    },
    {
        "id": "e207d1a66a7650b9",
        "type": "http response",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "http-get-device-state-response",
        "statusCode": "",
        "headers": {
            "content-type": "application/json"
        },
        "x": 850,
        "y": 400,
        "wires": []
    },
    {
        "id": "f89e2f3dce998039",
        "type": "http in",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "",
        "url": "/api/states/device/:deviceId/dates",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 230,
        "y": 460,
        "wires": [
            [
                "197bb63a4e854458"
            ]
        ]
    },
    {
        "id": "197bb63a4e854458",
        "type": "function",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "get-device-states-by-dates",
        "func": "const { getDeviceStatesByDates } = global.get('routes');\n\nreturn await getDeviceStatesByDates(msg);\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 460,
        "wires": [
            [
                "d246a8475b5673ea"
            ]
        ]
    },
    {
        "id": "d246a8475b5673ea",
        "type": "http response",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "http-device-states-by-dates-response",
        "statusCode": "",
        "headers": {},
        "x": 870,
        "y": 460,
        "wires": []
    },
    {
        "id": "443b413283d10c89",
        "type": "function",
        "z": "2dca6eed12b296f5",
        "g": "b74b1a6d538c13c2",
        "name": "post-device-state-to-database",
        "func": "const { storeStates } = global.get('services');\n\nreturn await storeStates(msg, global);",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 960,
        "wires": [
            []
        ]
    },
    {
        "id": "abf540bef0e1bad8",
        "type": "inject",
        "z": "2dca6eed12b296f5",
        "g": "b74b1a6d538c13c2",
        "name": "set-interval-1min",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "60",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 170,
        "y": 960,
        "wires": [
            [
                "443b413283d10c89"
            ]
        ]
    },
    {
        "id": "d995a6e870520226",
        "type": "http in",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "",
        "url": "/api/mnemoschemas/device/:deviceId",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 240,
        "y": 520,
        "wires": [
            [
                "82bde83f79f43412"
            ]
        ]
    },
    {
        "id": "82bde83f79f43412",
        "type": "function",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "get-device-mnemoschema",
        "func": "const { getDeviceMnemoschema } = global.get('routes');\n\nreturn await getDeviceMnemoschema(msg);",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 520,
        "wires": [
            [
                "87a20acffb88c509"
            ]
        ]
    },
    {
        "id": "87a20acffb88c509",
        "type": "http response",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "http-get-device-mnemoschema-response",
        "statusCode": "",
        "headers": {},
        "x": 880,
        "y": 520,
        "wires": []
    },
    {
        "id": "ae53f3a719dc646f",
        "type": "http in",
        "z": "2dca6eed12b296f5",
        "g": "d4fc72a987396215",
        "name": "",
        "url": "/health-check",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 160,
        "wires": [
            [
                "93590fb695220b2f"
            ]
        ]
    },
    {
        "id": "93590fb695220b2f",
        "type": "function",
        "z": "2dca6eed12b296f5",
        "g": "d4fc72a987396215",
        "name": "/health-check",
        "func": "const { healthCheck } = global.get('routes');\n\nreturn healthCheck(msg);",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 160,
        "wires": [
            [
                "0c78d8dd9d12fd1e"
            ]
        ]
    },
    {
        "id": "0c78d8dd9d12fd1e",
        "type": "http response",
        "z": "2dca6eed12b296f5",
        "g": "d4fc72a987396215",
        "name": "http-health-check-response",
        "statusCode": "",
        "headers": {},
        "x": 750,
        "y": 160,
        "wires": []
    },
    {
        "id": "a2eba094e5646ec9",
        "type": "http in",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "",
        "url": "/api/flows",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 280,
        "wires": [
            [
                "887420d8a5fb0d1d"
            ]
        ]
    },
    {
        "id": "887420d8a5fb0d1d",
        "type": "function",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "get-flows",
        "func": "const { getFlows } = global.get('routes');\n\nreturn await getFlows(msg);",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 480,
        "y": 280,
        "wires": [
            [
                "fafd204ba26a1f01"
            ]
        ]
    },
    {
        "id": "fafd204ba26a1f01",
        "type": "http response",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "http-get-flows-response",
        "statusCode": "",
        "headers": {},
        "x": 830,
        "y": 280,
        "wires": []
    },
    {
        "id": "43c3767d3d434ea5",
        "type": "http in",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "",
        "url": "/api/quick-helps/:referenceKey",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 220,
        "y": 640,
        "wires": [
            [
                "5bc46af389db248b"
            ]
        ]
    },
    {
        "id": "5bc46af389db248b",
        "type": "function",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "get-quick-helps",
        "func": "const { getQuickHelps } = global.get('routes');\n\nreturn await getQuickHelps(msg);",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 640,
        "wires": [
            [
                "0eef86469c73bd2e"
            ]
        ]
    },
    {
        "id": "0eef86469c73bd2e",
        "type": "http response",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "http-get-quick-helps-response",
        "statusCode": "",
        "headers": {},
        "x": 850,
        "y": 640,
        "wires": []
    },
    {
        "id": "28cb881e9abfb828",
        "type": "http in",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "",
        "url": "/api/states/device/:deviceId",
        "method": "post",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 210,
        "y": 700,
        "wires": [
            [
                "42be60bdf4323128",
                "40214b7ade58103d"
            ]
        ]
    },
    {
        "id": "6e554427850e7e1a",
        "type": "http response",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "http-post-device-state-response",
        "statusCode": "",
        "headers": {},
        "x": 850,
        "y": 700,
        "wires": []
    },
    {
        "id": "42be60bdf4323128",
        "type": "link out",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "link-post-state",
        "mode": "link",
        "links": [
            "f6dc65181c21674e"
        ],
        "x": 425,
        "y": 760,
        "wires": []
    },
    {
        "id": "40214b7ade58103d",
        "type": "function",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "post-device-state-stub",
        "func": "node.warn(msg);\n\nmsg.statusCode = 201;\nmsg.payload = {\n    message: 'Запрос на изменение состояния устройства принят.'\n};\n\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 520,
        "y": 700,
        "wires": [
            [
                "6e554427850e7e1a"
            ]
        ]
    },
    {
        "id": "8dfd0c2c64939220",
        "type": "http in",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "",
        "url": "/api/devices/:deviceId",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 800,
        "wires": [
            [
                "6b6d605b33ba622a"
            ]
        ]
    },
    {
        "id": "6b6d605b33ba622a",
        "type": "function",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "get-device",
        "func": "const { getDevice } = global.get(\"routes\");\n\nreturn await getDevice(msg);",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 800,
        "wires": [
            [
                "8e7193e6b1cfc533"
            ]
        ]
    },
    {
        "id": "8e7193e6b1cfc533",
        "type": "http response",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "http-get-device-response",
        "statusCode": "",
        "headers": {},
        "x": 830,
        "y": 800,
        "wires": []
    },
    {
        "id": "cfd3bfec49dd036d",
        "type": "http in",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "",
        "url": "/api/data-schemas/device/:deviceId",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 230,
        "y": 580,
        "wires": [
            [
                "6d432d77ac870b96"
            ]
        ]
    },
    {
        "id": "6d432d77ac870b96",
        "type": "function",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "get-device-state-data-schema",
        "func": "const { getDeviceStateDataschema } = global.get('routes');\n\nreturn await getDeviceStateDataschema(msg);",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 550,
        "y": 580,
        "wires": [
            [
                "599dd7db8ee5cbb5"
            ]
        ]
    },
    {
        "id": "599dd7db8ee5cbb5",
        "type": "http response",
        "z": "2dca6eed12b296f5",
        "g": "41c82c569adc9a0c",
        "name": "http-get-device-state-data-schema-response",
        "statusCode": "",
        "headers": {},
        "x": 890,
        "y": 580,
        "wires": []
    },
    {
        "id": "3254130808eb2f14",
        "type": "inject",
        "z": "a7c135e772de0725",
        "name": "on-init",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "0.01",
        "topic": "",
        "x": 130,
        "y": 60,
        "wires": [
            [
                "a01bf9c6243144ca"
            ]
        ]
    },
    {
        "id": "a01bf9c6243144ca",
        "type": "function",
        "z": "a7c135e772de0725",
        "name": "init-device-states",
        "func": "const [{ Op }, { FlowDataModel, DeviceDataModel } ] = global.get(['sequelize', 'orm']);\nconst flowUid = node.path.split('/').find(_=> true);\n\nconst params = [\n    [\n        \"startStop\", \"lowLevel\", \"midLevel\",\n        \"hiLevel\", \"emergencyLevel\", \"statePump1\",\n        \"statePump2\", \"resetFaultPump1\", \"resetFaultPump2\",\n        \"resetOperatingTimePump1\", \"resetOperatingTimePump2\",\n        \"faultPump1\", \"faultPump2\"\n    ],\n    [\n        \"timePump1\",\n        \"timePump2\"\n    ]\n];\nconst initialState = {};\n\nflow.set([\"coilsParams\", \"holdingsParams\"], params);\n\n\nconst devices = await DeviceDataModel.findAll({\n    attributes: ['id'],\n    include: [{\n        model: FlowDataModel,\n        as: 'flow',\n        attributes: [],\n        where: {\n            uid: flowUid\n        }\n    }]\n});\n\ndevices.forEach(d => {\n    params.forEach(params => {\n        params.forEach((p, i) => {\n            initialState[p] = undefined;\n        });\n    });\n    \n    global.set(`deviceState${d.id}`, initialState);\n});\n\nmsg.payload = { message: \"OnInit was completed.\" }\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "a59a21eb6b6471bc",
        "type": "function",
        "z": "a7c135e772de0725",
        "name": "build-state-payload",
        "func": "\nflow.set(\"res\", msg.res);\n\nmsg.payload = {\n    ...msg.payload, fc: 5, quantity: 1\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 420,
        "wires": [
            [
                "762ef4d95887673c"
            ]
        ]
    },
    {
        "id": "f6dc65181c21674e",
        "type": "link in",
        "z": "a7c135e772de0725",
        "name": "link in 1",
        "links": [
            "42be60bdf4323128"
        ],
        "x": 75,
        "y": 420,
        "wires": [
            [
                "a59a21eb6b6471bc"
            ]
        ]
    },
    {
        "id": "762ef4d95887673c",
        "type": "modbus-flex-write",
        "z": "a7c135e772de0725",
        "name": "",
        "showStatusActivities": false,
        "showErrors": false,
        "showWarnings": true,
        "server": "e8c1afd9a301aa03",
        "emptyMsgOnFail": false,
        "keepMsgProperties": false,
        "delayOnStart": false,
        "startDelayTime": "",
        "x": 650,
        "y": 420,
        "wires": [
            [],
            []
        ]
    },
    {
        "id": "03e587130931a889",
        "type": "inject",
        "z": "a7c135e772de0725",
        "name": "set-interval-10sec",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "10",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 170,
        "y": 260,
        "wires": [
            [
                "2db1e19264fd6a1a"
            ]
        ]
    },
    {
        "id": "2db1e19264fd6a1a",
        "type": "function",
        "z": "a7c135e772de0725",
        "name": "switch-device-connection",
        "func": "const [{ Op }, { FlowDataModel, DeviceDataModel }] = global.get(['sequelize', 'orm']);\nconst flowUid = node.path.split('/').find(_=> true);\n\nconst devices = await DeviceDataModel.findAll({\n    attributes: ['id', 'code', 'settings' ],\n    order: [[\"id\"]],\n    include: [{\n        model: FlowDataModel,\n        as: 'flow',\n        attributes: [],\n        where: {\n            uid: flowUid\n        },\n       \n    }]\n});\n\nlet deviceIndex = flow.get(\"deviceIndex\") || 0;\n\nif (deviceIndex >= devices.length) {\n    deviceIndex = 0;\n};\n\n\nconst device = devices[deviceIndex];\nif (device) {\n    msg.payload = {\n        connectorType: 'TCP',\n        tcpHost: device.settings.ip,\n        tcpPort: device.settings.port,\n        clientTimeout: 1000,\n        unitId: 1,\n    };\n    msg.deviceId = device.id;\n\n\n    flow.set(\"deviceIndex\", deviceIndex + 1);\n    flow.set(\"deviceId\", device.id);\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 260,
        "wires": [
            [
                "b0025aba6923fd52"
            ]
        ]
    },
    {
        "id": "f641c61327d806f0",
        "type": "modbus-flex-getter",
        "z": "a7c135e772de0725",
        "name": "",
        "showStatusActivities": true,
        "showErrors": true,
        "showWarnings": true,
        "logIOActivities": false,
        "server": "e8c1afd9a301aa03",
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": true,
        "keepMsgProperties": true,
        "delayOnStart": false,
        "enableDeformedMessages": false,
        "startDelayTime": "",
        "x": 650,
        "y": 340,
        "wires": [
            [
                "bfb3e9ec73ddd77c"
            ],
            [
                "0cde6358fb843fa9"
            ]
        ]
    },
    {
        "id": "bfb3e9ec73ddd77c",
        "type": "function",
        "z": "a7c135e772de0725",
        "name": "collect-device-state",
        "func": "\nconst deviceId = flow.get(\"deviceId\");\n// node.warn(deviceId);\nif (!deviceId) {\n    return;\n}\n\nlet deviceState = global.get(`deviceState${deviceId}`);\n\nconst updateState = (params) => {\n    params.forEach((p, i) => {\n        const v = {};\n        v[p] = msg.payload[i];\n        deviceState = { ...deviceState, ...v };\n    });\n}\n\nif (msg.topic) {\n    const params = flow.get(`${msg.topic}Params`);\n    updateState(params);\n}\nglobal.set(`deviceState${deviceId}`, {...deviceState, timestamp: Date.now()});\n\n\nreturn deviceState;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 870,
        "y": 340,
        "wires": [
            []
        ]
    },
    {
        "id": "b0025aba6923fd52",
        "type": "modbus-flex-connector",
        "z": "a7c135e772de0725",
        "name": "",
        "maxReconnectsPerMinute": 4,
        "emptyQueue": false,
        "showStatusActivities": true,
        "showErrors": true,
        "server": "e8c1afd9a301aa03",
        "emptyMsgOnFail": true,
        "configMsgOnChange": false,
        "x": 670,
        "y": 260,
        "wires": [
            [
                "a11210cfe3903d4f"
            ]
        ]
    },
    {
        "id": "30f6276f9e368846",
        "type": "function",
        "z": "a7c135e772de0725",
        "name": "switch-reading-registers",
        "func": "const registers = [\n    { name: \"coils\", address: 0, fc: 1, quantity: 13 },\n    { name: \"holdings\", address: 0, fc: 3, quantity: 2 },\n];\n\nlet registerIndex = flow.get(\"registerIndex\") || 0;\n\nif (registerIndex >= registers.length) {\n    registerIndex = 0;\n}\n\nconst register = registers[registerIndex];\n\nmsg.payload = {\n    fc: register.fc,\n    address: register.address,\n    quantity: register.quantity,\n};\n\nmsg.topic = register.name;\n\nflow.set(\"registerIndex\", registerIndex + 1);\n\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 340,
        "wires": [
            [
                "f641c61327d806f0"
            ]
        ]
    },
    {
        "id": "04a22057bd75906f",
        "type": "inject",
        "z": "a7c135e772de0725",
        "name": "set-interval-2sec",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "2",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 170,
        "y": 340,
        "wires": [
            [
                "30f6276f9e368846"
            ]
        ]
    },
    {
        "id": "a11210cfe3903d4f",
        "type": "debug",
        "z": "a7c135e772de0725",
        "name": "debug 2",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 910,
        "y": 200,
        "wires": []
    },
    {
        "id": "0cde6358fb843fa9",
        "type": "debug",
        "z": "a7c135e772de0725",
        "name": "debug 3",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 870,
        "y": 400,
        "wires": []
    }
]